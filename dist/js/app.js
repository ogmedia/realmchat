!function(){function e(e){var i=$("#game-zone").offset();x.x=(e.clientX-i.left)/S.domElement.width*2-1,x.y=2*-((e.clientY-i.top)/S.domElement.height)+1,b.setFromCamera(x,B);var t=b.intersectObjects([l]);if(t.length>0){var n=parseInt(Math.floor(t[0].point.x)/r),o=parseInt(Math.floor(t[0].point.z)/r),a=parseInt(Math.floor(t[0].point.x)%r),h=parseInt(Math.floor(t[0].point.z)%r),p=n,m=o,u=null,f=null;a>0?(u=p*r+r/2,n++):0>a?(u=p*r-r/2,n--):p>=0?(u=p*r+r/2,n++):(u=p*r-r/2,n--),h>0?(f=m*r+r/2,o++):0>h?(f=m*r-r/2,o--):m>=0?(f=m*r+r/2,o++):(f=m*r-r/2,o--);var w={x:u,y:1,z:f},E={x:u,y:3,z:f},v=g.findWhere({id:s.uid}),y=v.get("grid");if(y&&y.x&&y.z&&(c.child("x").child(y.x).child("players").child(s.uid).remove(),c.child("z").child(y.z).child("players").child(s.uid).remove()),d.child(s.uid).child("position").set(E),d.child(s.uid).child("grid").set({x:n,z:o}),c.child("x").child(n).child("players").child(s.uid).set(Firebase.ServerValue.TIMESTAMP),c.child("z").child(o).child("players").child(s.uid).set(Firebase.ServerValue.TIMESTAMP),!L){var M=new THREE.BoxGeometry(50,"-.5",50),T=new THREE.MeshBasicMaterial({color:6750054});L=new THREE.Mesh(M,T),F.add(L)}L.position.set(w.x,w.y,w.z),C(n,o)}}function i(){k=document.createElement("div"),$("#game-zone").append(k),B=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-500,1e3),B.position.x=200,B.position.y=100,B.position.z=200,F=new THREE.Scene;var e=function(){var e=a,i=r,t=new THREE.GridHelper(e,i);F.add(t);var n=new THREE.BoxGeometry(1e3,0,1e3),o=new THREE.MeshBasicMaterial({color:16776960,wireframe:!0});l=new THREE.Mesh(n,o),F.add(l)},i=function(){var e=new THREE.AmbientLight(16*Math.random());F.add(e);var i=new THREE.DirectionalLight(16777215*Math.random());i.position.x=Math.random()-.5,i.position.y=Math.random()-.5,i.position.z=Math.random()-.5,i.position.normalize(),F.add(i)},n=function(){S=new THREE.CanvasRenderer,S.setClearColor(15790320),S.setPixelRatio(window.devicePixelRatio),S.setSize(window.innerWidth,window.innerHeight),k.appendChild(S.domElement)};e(),i(),n(),window.addEventListener("resize",t,!1)}function t(){B.left=window.innerWidth/-2,B.right=window.innerWidth/2,B.top=window.innerHeight/2,B.bottom=window.innerHeight/-2,B.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight)}function n(){requestAnimationFrame(n),W.begin(),o(),W.end()}function o(){var e=1e-5*Date.now();B.position.x=200*Math.cos(e),B.position.z=200*Math.sin(e),B.lookAt(F.position),S.render(F,B)}var a=500,r=50,l=null,d=new Firebase("https://realmchat.firebaseio.com/players"),c=new Firebase("https://realmchat.firebaseio.com/grid"),s=null,h=Backbone.Model.extend({player_model:null,defaults:{grid:{x:0,z:0},position:{x:0,z:0}},initialize:function(){var e=this.get("profile").avatar,i=new THREE.BoxGeometry(12.5,12.5,12.5),t=(new THREE.TextureLoader).load(e);t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping;var n=new THREE.MeshLambertMaterial({color:16776960,map:t,overdraw:.5});this.player_model=new THREE.Mesh(i,n),this.player_model.position.x=this.get("position").x,this.player_model.position.y=2,this.player_model.position.z=this.get("position").z,F.add(this.player_model)}}),p=Backbone.Firebase.Collection.extend({model:h,url:"https://realmchat.firebaseio.com/players"}),m=Backbone.Firebase.Collection.extend({url:"https://realmchat.firebaseio.com/grid/x"}),u=Backbone.Firebase.Collection.extend({url:"https://realmchat.firebaseio.com/grid/z"}),f=Backbone.View.extend({tagName:"span",template:_.template('<img src="<%=image%>" class="img-circle" />'),intialize:function(){console.log(this.model)},render:function(){return this.$el.html(this.template({image:this.model.get("avatar")})),this}}),w=Backbone.View.extend({tagName:"div",className:"modal fade",template:_.template($("#join-modal-template").html()),events:{"click .join-chat":"join_chat","click .cancel-chat":"cancel_chat"},initialize:function(){document.removeEventListener("mousedown",e,!1),this.$el.html(this.template());var i=this;this.collection.forEach(function(e){var t=new f({model:e});t.render(),i.$el.find(".modal-body").append(t.$el.html())}),this.render()},render:function(){return this.$el.modal({backdrop:"static"}),this.$el.modal("show"),this},cancel_chat:function(){this.$el.modal("hide"),document.addEventListener("mousedown",e,!1)}}),g=new p,E=new m,v=new u;g.on("change",function(e){var i=e.get("position");e.player_model.position.set(i.x,i.y,i.z)});var b=new THREE.Raycaster,x=new THREE.Vector2,y=function(e){var i={},t=Math.floor(2*Math.random()+1);i.x=50*Math.floor((1e3*Math.random()-500)/50)+25,i.y=50*t/2,d.child(e).child("position").set(i)},M=function(e){d.child(e).child("position").once("value",function(i){var t=i.val();t||y(e)})},T=function(e,i){var t={name:e.displayName,avatar:e.profileImageURL};d.child(i).child("profile").set(t),$("#profile").text(e.displayName),$("#logins").hide(),M(i)},z=function(){d.authWithOAuthPopup("twitter",function(e,i){e?console.log("Login Failed!",e):T(i.twitter,i.uid)})},H=function(){d.authWithOAuthPopup("facebook",function(e,i){e?console.log("Login Failed!",e):T(i.facebook,i.uid)})},R=function(){var e=Backbone.View.extend({el:"#header",events:{"click #twitter-login":z,"click #facebook-login":H},initialize:function(){this.render()},render:function(){this.$el.append('<a href="http://realmchat.github.io" target="_blank">realmchat</a> <span id="profile"></span>'),this.$el.append('<span id="logins"><button class="btn btn-default" id="twitter-login">Twitter</button> | <button class="btn btn-default" id="facebook-login">Facebook</button></span>')}});new e,d.onAuth(function(e){e&&(d.child(e.uid).child("lastActive").set(Firebase.ServerValue.TIMESTAMP),"facebook"===e.provider&&T(e.facebook,e.uid),"twitter"===e.provider&&T(e.twitter,e.uid),s=e)})};R();var k,W,B,F,S;document.addEventListener("mousedown",e,!1);var L=!1,A=function(){W=new Stats,W.domElement.style.position="absolute",W.domElement.style.top="0px",W.domElement.style.right="0px",$("#header").append(W.domElement)};A(),i(),n();var C=function(e,i){var t=g.findWhere({id:s.uid}),n=(t.get("grid"),E.findWhere({id:e.toString()})),o=Object.keys(n.get("players")).filter(function(e){return e!==s.uid});if(o.length>0){var a=v.findWhere({id:i.toString()}),r=Object.keys(a.get("players")).filter(function(e){return e!==s.uid});r.length>0&&Promise.all(r.map(I)).then(function(e){P(e)})}},P=function(e){var i=e.map(function(e){return e}),t=new Backbone.Collection(i);new w({collection:t})},I=function(e){return new Promise(function(i,t){d.child(e).child("profile").once("value",function(e){i(e.val())},function(e){t(e)})})}}(THREE);